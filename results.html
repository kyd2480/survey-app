<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>응답 리스트</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      padding: 1rem;
      font-family: sans-serif;
    }

    h1 {
      margin-bottom: 1rem;
    }

    button {
      margin-right: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f4f4f4;
    }

    td.question-text {
      text-align: left;
    }
  </style>
</head>

<body>
  <h1>설문 응답 목록</h1>
  <button id="downloadAll">전체 다운로드</button>
  <button id="downloadSel">선택 다운로드</button>
  <table id="respTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll"></th>
        <th>파트</th>
        <th>평가자</th>
        <th>평가대상자</th>
        <th>다운로드</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyDSrSDzGSuzVw1mfeCUfXvmq7mT0SP0UBQ",
      authDomain: "survey-46c04.firebaseapp.com",
      projectId: "survey-46c04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 문항 정의
    const questions = [
      { big: "인성 및 기본역량", mid: "기본인성", text: "근태(출근) 상태는 양호한가요?" },
      { big: "", mid: "", text: "인사성이 좋은가요? 비속어나 욕설을 사용하지 않고 바른말을 잘 사용하는 편인가요?" },
      { big: "", mid: "", text: "비속어나 욕설을 사용하지않고 바른말을 잘 사용하는 편인가요?" },
      { big: "", mid: "", text: "시간제, 정직원, 장애우 근로자를 구분하지 않고 모두를 존중하는 예의바른 태도를 가지고 있나요?" },
      { big: "", mid: "관계성", text: "직원들과의 관계성이 좋은 편인가요?" },
      { big: "", mid: "협조/참여", text: "타부서의 도움요청에 적극 협조하고 참여함에 도움이 되는 편인가요?" },
      { big: "", mid: "집중력", text: "산만하지 않고 일에 집중력이 좋은 편인가요?" },
      { big: "", mid: "분위기메이커", text: "같이 근무함에 있어 밝고 긍정적인 분위기를 조성하는 편인가요?" },
      { big: "", mid: "소통", text: "상대방의 의견을 인정하고 수용하며 대화·소통이 잘 되는 편인가요?" },
      { big: "", mid: "솔선수범", text: "모든 일에 솔선수범하며 적극적으로 근무하나요?" },
      { big: "", mid: "책임감", text: "맡은역할에 책임감이 강한편인가요?" },
      { big: "", mid: "지시이행", text: "회사 및 관리자의 지시를 잘 이행하고 따르는 편인가요?" },
      { big: "인원운영역량", mid: "작업지시", text: "정확한 작업지시를 하는편인가요?" },
      { big: "", mid: "공정성", text: "편향적이지않고 모두에게 공정한가요?" },
      { big: "", mid: "효율성", text: "인원 운영은 효율적으로 운영하고 있나요?" },
      { big: "", mid: "통솔력", text: "인원 *통솔력은 갖추고 있나요? *팀원들에게 존중받고, 본인의 지시에 적극적으로 팔로우 가능한 역량" },
      { big: "", mid: "관리", text: "관리하는 팀원들에게 관심갖고 필요한 역량을 끌어내는 편인가요?" },
      { big: "문제해결능력", mid: "우선순위", text: "업무의 우선순위를 잘 구분하고 계획적으로 진행하나요?" },
      { big: "", mid: "판단력", text: "문제(이슈) 발생시 빠른판단을 하는편인가요?" },
      { big: "", mid: "보고/공유", text: "문제(이슈) 발생시 빠른 보고와 현장공유를 잘 하는편인가요?" },
      { big: "", mid: "해결능력", text: "문제(이슈) 발생시 해결능력이 좋은 편인가요?" },
      { big: "화주사 소통/관계성", mid: "업체조율", text: "화주사와 관계성 및 이슈사항 조율을 원할하게 잘하는 편인가요?" },
      { big: "물류관리", mid: "시설관리", text: "물류內 모든시설과 안전사고에 관해 책임있게 점검하고 관리를 잘하는 편인가요?" },
      { big: "*테크닉", mid: "문화 운영능력", text: "새로고침 *문화 운영과 개선은 원할히 하는편인가요? *인사/조회/근태관리/환경정리/존중,존칭 및 존댓말/연장근무/휴게시간등" },
      { big: "", mid: "★매니지먼트", text: "직원들 *매니지먼트 역할은 잘하는 편인가요? *면담을 통한 설명/이해/설득/회유/개선/조치/해소/고충처리등 '직원과의 면담능력'" },
      { big: "", mid: "이미지메이킹", text: "본인 이미지에 맞게 복장과 스타일은 깔끔하고 준수한 편인가요?" },
      { big: "개선/성장 가능성", mid: "가능성", text: "부족한 점은 개선하고 성장할 가능성이 있나요?" },
    ];

    const tbody = document.querySelector('#respTable tbody');
    let allResponses = [];

    // 1) 데이터 로드 & 테이블 채우기
    db.collection('responses').orderBy('time').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const r = { id: doc.id, ...doc.data() };
          allResponses.push(r);

          const tr = document.createElement('tr');
          // 체크박스
          const chkTd = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.classList.add('rowChk');
          chk.dataset.id = doc.id;
          chkTd.appendChild(chk);
          tr.appendChild(chkTd);

          // 파트, 이름, 평가자
          ['part', 'manager', 'name'].forEach(key => {
            const td = document.createElement('td');
            td.textContent = r[key] || '';
            tr.appendChild(td);
          });

          // 행별 다운로드 버튼
          const btnTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '다운로드';
          btn.addEventListener('click', () => triggerDownload([r]));
          btnTd.appendChild(btn);
          tr.appendChild(btnTd);

          tbody.appendChild(tr);
        });

        // 전체 선택 토글
        document.getElementById('chkAll').addEventListener('change', e => {
          document.querySelectorAll('.rowChk')
            .forEach(cb => cb.checked = e.target.checked);
        });

        // 전체 다운로드
        document.getElementById('downloadAll').addEventListener('click', () => {
          triggerDownload(allResponses);
        });

        // 선택 다운로드
        document.getElementById('downloadSel').addEventListener('click', () => {
          const selIds = Array.from(document.querySelectorAll('.rowChk:checked'))
            .map(cb => cb.dataset.id);
          const sel = allResponses.filter(r => selIds.includes(r.id));
          if (!sel.length) return alert('하나 이상 선택해주세요.');
          triggerDownload(sel);
        });
      })
      .catch(console.error);

    // 2) 엑셀 다운로드 함수 (.xls HTML 방식)
    // SheetJS 기반: 하나의 .xlsx 에 다중 시트(tab) 생성
    async function triggerDownload(responses) {
      const workbook = new ExcelJS.Workbook();

      for (const r of responses) {
        const name = `${r.part}_${r.manager}`.substring(0, 31);
        const sheet = workbook.addWorksheet(name);

        // 1) Meta rows
        sheet.addRow(['부서', r.part]);
        sheet.addRow(['평가자', r.manager || '']);
        sheet.addRow(['평가대상자', r.name]);
        //sheet.addRow([]); // spacer

        // 2) Header row
        const header = ['대분류', '중분류', '질문', '네', '보통', '아니오', '해당사항없습니다'];
        const headerRow = sheet.addRow(header);

        // Style header
        headerRow.eachCell(cell => {
          cell.font = { bold: true };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = {
            top: { style: 'thin' }, left: { style: 'thin' },
            bottom: { style: 'thin' }, right: { style: 'thin' }
          };
        });

        // 3) Data rows with grouping+merges
        // First fill big/mid arrays
        const filledBig = [], filledMid = [];
        questions.forEach((q, i) => {
          filledBig[i] = q.big || (i > 0 ? filledBig[i - 1] : '');
          filledMid[i] = q.mid || (i > 0 ? filledMid[i - 1] : '');
        });
        // Calculate spans
        const bigSpans = [], midSpans = [];
        questions.forEach((_, i) => {
          if (i === 0 || filledBig[i] !== filledBig[i - 1]) {
            const cnt = filledBig.slice(i).findIndex(x => x !== filledBig[i]);
            bigSpans[i] = (cnt < 0 ? questions.length - i : cnt);
          } else bigSpans[i] = 0;
          if (i === 0 || filledMid[i] !== filledMid[i - 1]) {
            const cnt = filledMid.slice(i).findIndex(x => x !== filledMid[i]);
            midSpans[i] = (cnt < 0 ? questions.length - i : cnt);
          } else midSpans[i] = 0;
        });

        // Add each question row
        for (let i = 0; i < questions.length; i++) {
          const q = questions[i];
          const ans = r['q' + (i + 1)] || '';
          const row = sheet.addRow([
            filledBig[i],
            filledMid[i],
            q.text,
            ...(['네', '보통', '아니오', '해당사항없습니다']
              .map(opt => opt === ans ? '●' : '○'))
          ]);
          // Style all cells in this row
          row.eachCell((cell, colNum) => {
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = {
              top: { style: 'thin' }, left: { style: 'thin' },
              bottom: { style: 'thin' }, right: { style: 'thin' }
            };
            if (colNum === 3) { // question text
              cell.alignment = { horizontal: 'left', vertical: 'middle' };
            }
          });
          // Apply merges on big/mid columns
          if (bigSpans[i] > 1) {
            sheet.mergeCells(
              row.number,    // start row
              1,             // start col
              row.number + bigSpans[i] - 1,
              1
            );
          }
          if (midSpans[i] > 1) {
            sheet.mergeCells(
              row.number,
              2,
              row.number + midSpans[i] - 1,
              2
            );
          }
          // Clear duplicate text in merged cells
          if (bigSpans[i] > 1) sheet.getCell(row.number + 1, 1).value = null;
          if (midSpans[i] > 1) sheet.getCell(row.number + 1, 2).value = null;
        }
      }

      // 4) Export
      const buf = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'responses.xlsx';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>

</script>
</body>

</html>