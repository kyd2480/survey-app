<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>응답 리스트</title>
</head>
<body>
  <h1>설문 응답 목록</h1>
  <table id="respTable" border="1" cellpadding="6">
    <thead>
      <tr>
        <th>시간</th><th>파트</th><th>이름</th>
        <!-- q1 ~ q10 헤더 -->
        <th>질문1</th><th>질문2</th><!-- ... --><th>질문10</th>
        <th>다운로드</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // 1) Firebase 초기화 (survey.html과 동일하게)
    const firebaseConfig = {
      apiKey: "AIzaSyDSrSDzGSuzVw1mfeCUfXvmq7mT0SP0UBQ",
      authDomain: "survey-46c04.firebaseapp.com",
      projectId: "survey-46c04",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tbody = document.querySelector('#respTable tbody');

    // 2) Firestore에서 응답 불러오기
    db.collection('responses').orderBy('time').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const r = doc.data();
          const tr = document.createElement('tr');
          // 시간, 파트, 이름
          const timeTd = document.createElement('td');
          timeTd.textContent = r.time?.toDate().toLocaleString() || '';
          tr.appendChild(timeTd);

          ['part','name'].forEach(key => {
            const td = document.createElement('td');
            td.textContent = r[key];
            tr.appendChild(td);
          });

          // q1~q10
          for (let i = 1; i <= 10; i++) {
            const td = document.createElement('td');
            td.textContent = r[`q${i}`] || '';
            tr.appendChild(td);
          }

          // 다운로드 버튼
          const btnTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '다운로드';
          btn.addEventListener('click', () => {
            // CSV 헤더 및 행 생성
            const header = ['시간','파트','이름'];
            for (let i = 1; i <= 10; i++) header.push(`질문${i}`);
            const row = [r.time.toDate().toISOString(), r.part, r.name];
            for (let i = 1; i <= 10; i++) row.push(r[`q${i}`] || '');
            const csv = [
              header.join(','),
              row.map(c => `"${(c+'').replace(/"/g,'""')}"`).join(',')
            ].join('\r\n');

            // 파일 다운로드
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            const safeName = r.name.replace(/\s+/g,'_');
            a.download = `${safeName}_${doc.id}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
          });
          btnTd.appendChild(btn);
          tr.appendChild(btnTd);

          tbody.appendChild(tr);
        });
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
