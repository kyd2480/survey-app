<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>응답 리스트</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    table { border-collapse: collapse; width:100%; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#f4f4f4; }

  </style>
</head>
<body>
  <h1>설문 응답 목록</h1>
  <table id="respTable">
    <thead>
      <tr>
        <th>파트</th>
        <th>평가대상자</th>
        <th>평가자</th>
        <th>다운로드</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase 초기화 (survey.html과 동일)
    const firebaseConfig = {
      apiKey: "AIzaSyDSrSDzGSuzVw1mfeCUfXvmq7mT0SP0UBQ",
      authDomain: "survey-46c04.firebaseapp.com",
      projectId: "survey-46c04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // survey.html 과 동일한 questions 배열
    const questions = [
      {big:"인성 및 기본역량", mid:"기본인성", text:"근태(출근) 상태는 양호한가요?"},
      {big:"", mid:"", text:"인사성이 좋은가요? 비속어나 욕설을 사용하지 않고 바른말을 잘 사용하는 편인가요?"},
      {big:"", mid:"", text:"비속어나 욕설을 사용하지않고 바른말을 잘 사용하는 편인가요?"},
      {big:"", mid:"", text:"시간제, 정직원, 장애우 근로자를 구분하지 않고 모두를 존중하는 예의바른 태도를 가지고 있나요?"},
      {big:"", mid:"관계성", text:"직원들과의 관계성이 좋은 편인가요?"},
      {big:"", mid:"협조/참여", text:"타부서의 도움요청에 적극 협조하고 참여함에 도움이 되는 편인가요?"},
      {big:"", mid:"집중력", text:"산만하지 않고 일에 집중력이 좋은 편인가요?"},
      {big:"", mid:"분위기메이커", text:"같이 근무함에 있어 밝고 긍정적인 분위기를 조성하는 편인가요?"},
      {big:"", mid:"소통", text:"상대방의 의견을 인정하고 수용하며 대화·소통이 잘 되는 편인가요?"},
      {big:"", mid:"솔선수범", text:"모든 일에 솔선수범하며 적극적으로 근무하나요?"},
      {big:"", mid:"책임감", text:"맡은역할에 책임감이 강한편인가요?"},
      {big:"", mid:"지시이행", text:"회사 및 관리자의 지시를 잘 이행하고 따르는 편인가요?"},
      {big:"인원운영역량", mid:"작업지시", text:"정확한 작업지시를 하는편인가요?"},
      {big:"", mid:"공정성", text:"편향적이지않고 모두에게 공정한가요?"},
      {big:"", mid:"효율성", text:"인원 운영은 효율적으로 운영하고 있나요?"},
      {big:"", mid:"통솔력", text:"인원 통솔력은 갖추고 있나요? 팀원들에게 존중받고, 본인의 지시에 적극적으로 팔로우 가능한 역량"},
      {big:"", mid:"관리", text:"관리하는 팀원들에게 관심갖고 필요한 역량을 끌어내는 편인가요?"},
      {big:"문제해결능력", mid:"우선순위", text:"업무의 우선순위를 잘 구분하고 계획적으로 진행하나요?"},
      {big:"", mid:"판단력", text:"문제(이슈) 발생시 빠른판단을 하는편인가요?"},
      {big:"", mid:"보고/공유", text:"문제(이슈) 발생시 빠른 보고와 현장공유를 잘 하는편인가요?"},
      {big:"", mid:"해결능력", text:"문제(이슈) 발생시 해결능력이 좋은 편인가요?"},
      {big:"화주사 소통/관계성", mid:"업체조율", text:"화주사와 관계성 및 이슈사항 조율을 원할하게 잘하는 편인가요?"},
      {big:"물류관리", mid:"시설관리", text:"물류内 모든시설과 안전사고에 관해 책임있게 점검하고 관리를 잘하는 편인가요?"},
      {big:"테크닉", mid:"문화 운영능력", text:"문화 운영과 개선은 원활히 하는편인가요?"},
      {big:"", mid:"매니지먼트", text:"직원들 매니지먼트 역할은 잘하는 편인가요?"},
      {big:"", mid:"이미지메이킹", text:"본인 이미지에 맞게 복장과 스타일은 깔끔하고 준수한 편인가요?"},
      {big:"개선/성장 가능성", mid:"가능성", text:"부족한 점은 개선하고 성장할 가능성이 있나요?"}
    ];

    const tbody = document.querySelector('#respTable tbody');

    db.collection('responses').orderBy('time').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const r = doc.data();
          const tr = document.createElement('tr');

          // 파트, 이름 셀
          ['part','name','manager'].forEach(key => {
            const td = document.createElement('td');
            td.textContent = r[key] || '';
            tr.appendChild(td);
          });

          // 다운로드 버튼
          const td = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '다운로드';
          btn.addEventListener('click', () => {
            const metaH = ['부서','평가대상자','평가자'];
            const metaV = [r.part, r.name, r.manager || '']
            .map(c => `"${(c+'').replace(/"/g,'""')}"`);

            // 2) 설문 헤더 (기존 질문 헤더 대신 옵션 칸 포함)
          const surveyH = ['대분류','중분류','질문','네','보통','아니오','해당사항없습니다'];

          // 3) 설문 응답행: 각 질문마다 ○● 표시
          const surveyRows = questions.map((q,i) => {
            // 사용자가 선택한 실제 값
          const answer = r['q'+(i+1)] || '';
          // 옵션 순서
           const opts   = ['네','좀 부족합니다','아니오','해당사항없습니다'];
          // 각 옵션별로 ● 또는 ○
           const circles = opts.map(label =>
          label === answer ? '●' : '○'
           );
           // 하나의 CSV 행으로
           const cells = [
           q.big, 
           q.mid, 
           q.text, 
           ...circles
          ].map(c => `"${(c+'').replace(/"/g,'""')}"`);
          return cells.join(',');
          });

          // 4) CSV 조합 (BOM + 메타헤더 + 값 + 빈줄 + 설문헤더 + 설문행)
          const bom = '\uFEFF';
          const csv = [
          bom + metaH.join(','),  // 부서,이름,평가자
          metaV.join(','),        // 실제 값
          '',                     // 빈 줄
          surveyH.map(h => `"${h}"`).join(','), // 질문+옵션 헤더
          ...surveyRows
          ].join('\r\n');


            // 다운로드
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safePart = (r.part||'').replace(/\s+/g,'_');
            a.download = `${safePart}_${r.name}_${doc.id}.csv`;
            a.href = url; a.click();
            URL.revokeObjectURL(url);
          });
          td.appendChild(btn);
          tr.appendChild(td);

          tbody.appendChild(tr);
        });
      })
      .catch(err => console.error(err));
  </script>
</body>
</html>
