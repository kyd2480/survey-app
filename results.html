<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>응답 리스트</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <h1>설문 응답 목록</h1>
  <table id="respTable" border="1" cellpadding="6">
    <thead>
      <tr>
        <th>파트</th>
        <th>이름</th>
        <th>다운로드</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase 초기화 (survey.html과 동일하게)
    const firebaseConfig = {
      apiKey: "AIzaSyDSrSDzGSuzVw1mfeCUfXvmq7mT0SP0UBQ",
      authDomain: "survey-46c04.firebaseapp.com",
      projectId: "survey-46c04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tbody = document.querySelector('#respTable tbody');

    db.collection('responses').orderBy('time').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const r = doc.data();
          const tr = document.createElement('tr');

          // 파트, 이름 셀
          ['part','name'].forEach(key => {
            const td = document.createElement('td');
            td.textContent = r[key] || '';
            tr.appendChild(td);
          });

          // 다운로드 버튼
          const btnTd = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '다운로드';
          btn.addEventListener('click', () => {
            // CSV 헤더 (질문 텍스트 포함)
            const headers = [
              '파트','이름',
              '근태(출근) 상태는 양호한가요?',
              '인사성이 좋은가요?',
              '모두를 존중하는 예의바른 태도를 가지고 있나요?',
              /* ... q4~q10 텍스트 ... */
            ];
            // row 값: q1~q10
            const row = [
              r.part, r.name,
              r.q1, r.q2, r.q3, r.q4, r.q5,
              r.q6, r.q7, r.q8, r.q9, r.q10
            ];
            const bom = '\uFEFF';
            const csv = bom
              + headers.join(',') + '\r\n'
              + row.map(c=>`"${(c+'').replace(/"/g,'""')}"`).join(',');
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safePart = (r.part||'').replace(/\s+/g,'_');
            a.download = `${safePart}_${r.name || 'unknown'}_${doc.id}.csv`;
            a.href = url; a.click();
            URL.revokeObjectURL(url);
          });
          btnTd.appendChild(btn);
          tr.appendChild(btnTd);

          tbody.appendChild(tr);
        });
      })
      .catch(err => console.error('응답 로드 실패:', err));
  </script>
</body>
</html>
