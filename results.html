<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>설문 응답 리스트</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    body {
      padding: 1rem;
      font-family: sans-serif;
    }

    h1 {
      margin-bottom: 1rem;
    }

    button {
      margin-right: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1rem;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f4f4f4;
    }

    td.question-text {
      text-align: left;
    }
  </style>
</head>

<body>
  <h1>설문 응답 목록</h1>
  <button id="downloadAll">전체 다운로드 (.xlsx)</button>
  <button id="downloadSel">선택 다운로드 (.xlsx)</button>

  <table id="respTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll"></th>
        <th>파트</th>
        <th>평가자</th>
        <th>대상자</th>
        <th>다운로드</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Firebase SDK & ExcelJS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyDSrSDzGSuzVw1mfeCUfXvmq7mT0SP0UBQ",
      authDomain: "survey-46c04.firebaseapp.com",
      projectId: "survey-46c04"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 문항 정의
    const questions = [
      { big: "인성 및 기본역량", mid: "기본인성", text: "근태(출근) 상태는 양호한가요?" },
      { big: "", mid: "", text: "인사성이 좋은가요? 비속어나 욕설을 사용하지 않고 바른말을 잘 사용하는 편인가요?" },
      { big: "", mid: "", text: "비속어나 욕설을 사용하지않고 바른말을 잘 사용하는 편인가요?" },
      { big: "", mid: "", text: "시간제, 정직원, 장애우 근로자를 구분하지 않고 모두를 존중하는 예의바른 태도를 가지고 있나요?" },
      { big: "", mid: "관계성", text: "직원들과의 관계성이 좋은 편인가요?" },
      { big: "", mid: "협조/참여", text: "타부서의 도움요청에 적극 협조하고 참여함에 도움이 되는 편인가요?" },
      { big: "", mid: "집중력", text: "산만하지 않고 일에 집중력이 좋은 편인가요?" },
      { big: "", mid: "분위기메이커", text: "같이 근무함에 있어 밝고 긍정적인 분위기를 조성하는 편인가요?" },
      { big: "", mid: "소통", text: "상대방의 의견을 인정하고 수용하며 대화·소통이 잘 되는 편인가요?" },
      { big: "", mid: "솔선수범", text: "모든 일에 솔선수범하며 적극적으로 근무하나요?" },
      { big: "", mid: "책임감", text: "맡은 역할에 책임감이 강한 편인가요?" },
      { big: "", mid: "지시이행", text: "회사 및 관리자의 지시를 잘 이행하고 따르는 편인가요?" },
      { big: "인원운영역량", mid: "작업지시", text: "정확한 작업지시를 하는 편인가요?" },
      { big: "", mid: "공정성", text: "편향적이지 않고 모두에게 공정한가요?" },
      { big: "", mid: "효율성", text: "인원 운영은 효율적으로 운영하고 있나요?" },
      { big: "", mid: "통솔력", text: "인원 *통솔력*은 갖추고 있나요? 팀원들에게 존중받고 본인의 지시에 적극적으로 팔로우 가능한 역량" },
      { big: "", mid: "관리", text: "관리하는 팀원들에게 관심 갖고 필요한 역량을 끌어내는 편인가요?" },
      { big: "문제해결능력", mid: "우선순위", text: "업무의 우선순위를 잘 구분하고 계획적으로 진행하나요?" },
      { big: "", mid: "판단력", text: "문제(이슈) 발생시 빠른 판단을 하는 편인가요?" },
      { big: "", mid: "보고/공유", text: "문제(이슈) 발생시 빠른 보고와 현장 공유를 잘 하는 편인가요?" },
      { big: "", mid: "해결능력", text: "문제(이슈) 발생시 해결능력이 좋은 편인가요?" },
      { big: "화주사 소통/관계성", mid: "업체조율", text: "화주사와 관계성 및 이슈사항 조율을 원활하게 잘 하는 편인가요?" },
      { big: "물류관리", mid: "시설관리", text: "물류内 모든 시설과 안전사고에 관해 책임 있게 점검하고 관리하는 편인가요?" },
      { big: "*테크닉", mid: "문화 운영능력", text: "새로고침 *문화 운영과 개선은 원활히 하는 편인가요?" },
      { big: "", mid: "★매니지먼트", text: "직원들과의 면담능력(설명/이해/설득/회유/개선/고충처리 등)은 뛰어난 편인가요?" },
      { big: "", mid: "이미지메이킹", text: "복장과 스타일은 깔끔하고 준수한 편인가요?" },
      { big: "개선/성장 가능성", mid: "가능성", text: "부족한 점은 개선하고 성장할 가능성이 있나요?" }
    ];

    // rowspan 병합을 위한 사전 계산
    const filledBig = [], filledMid = [];
    questions.forEach((q, i) => {
      filledBig[i] = q.big || (i > 0 ? filledBig[i - 1] : '');
      filledMid[i] = q.mid || (i > 0 ? filledMid[i - 1] : '');
    });
    const bigSpans = [], midSpans = [];
    questions.forEach((_, i) => {
      bigSpans[i] = (i === 0 || filledBig[i] !== filledBig[i - 1])
        ? (function () {
          const cnt = filledBig.slice(i).findIndex(x => x !== filledBig[i]);
          return cnt < 0 ? questions.length - i : cnt;
        })()
        : 0;
      midSpans[i] = (i === 0 || filledMid[i] !== filledMid[i - 1])
        ? (function () {
          const cnt = filledMid.slice(i).findIndex(x => x !== filledMid[i]);
          return cnt < 0 ? questions.length - i : cnt;
        })()
        : 0;
    });

    // 테이블에 Firestore 데이터 렌더링
    const tbody = document.querySelector('#respTable tbody');
    let allResponses = [];
    db.collection('responses').orderBy('time').get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const r = { id: doc.id, ...doc.data() };
          allResponses.push(r);

          const tr = document.createElement('tr');
          // 체크박스
          const tdChk = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox'; chk.classList.add('rowChk'); chk.dataset.id = doc.id;
          tdChk.appendChild(chk); tr.appendChild(tdChk);
          // 파트, 평가자, 대상자
          ['part', 'manager', 'name'].forEach(key => {
            const td = document.createElement('td');
            td.textContent = r[key] || '';
            tr.appendChild(td);
          });
          // 다운로드 버튼
          const tdBtn = document.createElement('td');
          const btn = document.createElement('button');
          btn.textContent = '다운로드';
          btn.addEventListener('click', () => triggerDownload([r]));
          tdBtn.appendChild(btn); tr.appendChild(tdBtn);

          tbody.appendChild(tr);
        });
        // 전체 선택 토글
        document.getElementById('chkAll').addEventListener('change', e => {
          document.querySelectorAll('.rowChk').forEach(cb => cb.checked = e.target.checked);
        });
        document.getElementById('downloadAll').addEventListener('click', () => triggerDownload(allResponses));
        document.getElementById('downloadSel').addEventListener('click', () => {
          const selIds = Array.from(document.querySelectorAll('.rowChk:checked'))
            .map(cb => cb.dataset.id);
          const sel = allResponses.filter(r => selIds.includes(r.id));
          if (!sel.length) return alert('하나 이상 선택해주세요.');
          triggerDownload(sel);
        });
      })
      .catch(console.error);

    // ExcelJS 기반 다운로드 함수
    async function triggerDownload(responses) {
      const workbook = new ExcelJS.Workbook();

      for (const r of responses) {
        const name = `${r.part}_${r.name}`.substring(0, 31);
        const sheet = workbook.addWorksheet(name);
        // 메타 정보
        [['부서', r.part], ['평가자', r.manager], ['평가대상자', r.name]].forEach(vals => {
          const row = sheet.addRow(vals);
          row.eachCell(cell => {
            cell.font = { bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
          });
        });
        sheet.addRow([]); // 구분용 빈 행
        // 헤더
        const header = ['대분류', '중분류', '질문', '네', '보통', '아니오', '해당사항없습니다'];
        const hdrRow = sheet.addRow(header);
        hdrRow.eachCell(cell => {
          cell.font = { bold: true };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        });
        // 본문
        for (let i = 0; i < questions.length; i++) {
          const q = questions[i];
          const ans = r['q' + (i + 1)] || '';
          const row = sheet.addRow([
            filledBig[i],
            filledMid[i],
            q.text,
            ans === '네' ? '●' : '○',
            ans === '보통' ? '●' : '○',
            ans === '아니오' ? '●' : '○',
            ans === '해당사항없습니다' ? '●' : '○'
          ]);
          row.eachCell((cell, col) => {
            cell.alignment = { horizontal: col === 3 ? 'left' : 'center', vertical: 'middle' };
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
          });
          if (bigSpans[i] > 1) sheet.mergeCells(row.number, 1, row.number + bigSpans[i] - 1, 1);
          if (midSpans[i] > 1) sheet.mergeCells(row.number, 2, row.number + midSpans[i] - 1, 2);
        }
        // 자동 너비 조정
        sheet.columns.forEach(col => {
          let max = 10;
          col.eachCell(c => max = Math.max(max, (c.value || '').toString().length + 2));
          col.width = max;
        });
      }
      const buf = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const filename = responses.length === 1
        ? `${responses[0].part}_${responses[0].name}.xlsx`
        : `responses_${Date.now()}.xlsx`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>

</html>